# Merlin Website Wizard v6.5 — AI Image Planner

## Implementation Report

**Date:** 2025-01-20  
**Version:** 6.5-ai-image-planner  
**Status:** ✅ Complete

---

## Executive Summary

Merlin v6.5 transforms image generation from "just generate a hero + random images" into a structured AI-driven image planning system. Images are now intelligently planned per section based on industry, tone, layout variant, and style system, ensuring visual consistency and thematic alignment.

---

## Objectives Achieved

✅ **AI Image Planning System**

- Created `server/ai/imagePlannerLLM.ts` with `planImagesForSite()` function
- Uses GPT-4o to generate intelligent prompts per section
- Plans images based on industry, tone, layout variant, and v6.2 style system
- Returns structured `PlannedImage` objects with purpose, prompt, styleHint, and alt text

✅ **Style System Integration**

- Extracts style hints from v6.2 style system (colors, typography, mood)
- Shapes prompt mood based on style system (e.g., oceanic palette → "cool teal/cyan lighting")
- Ensures visual consistency across all images

✅ **Image Generation Integration**

- Created `generateSectionImagesV65()` function
- Generates images using AI-planned prompts (not generic prompts)
- Hero sections always use AI-planned hero prompts
- Supporting/icon/background images use planned prompts
- Populates `section.imageUrl` (primary) and `section.supportImages[]` (additional)

✅ **HTML Rendering Updates**

- Updated features/services rendering to use `supportImages` for icons
- Images properly placed based on variant layout (side, background, icons)
- All section variants properly render planned images

✅ **Metadata Tracking**

- `metadata.json` includes `imagePlannerVersion: "6.5"`
- `metadata.json` includes `plannedImages` array (full plan)
- `metadata.json` includes `generatedImages` array (actual URLs)
- `image-plan.json` saved separately for reference

---

## Files Created

### 1. `server/ai/imagePlannerLLM.ts`

**Purpose:** AI-powered image planning per section

**Key Functions:**

- `planImagesForSite()` - Main function that generates image plans using GPT-4o
- `extractStyleHints()` - Extracts style hints from v6.2 style system
- `buildImagePlanningPrompt()` - Builds prompt for GPT-4o
- `generateFallbackImagePlan()` - Fallback when AI unavailable
- `generateAltFromPrompt()` - Generates alt text from prompts

**Interfaces:**

```typescript
export interface PlannedImage {
  sectionKey: string; // e.g. "hero-1", "about-1"
  purpose: 'hero' | 'supporting' | 'icon' | 'background';
  prompt: string;
  styleHint?: string;
  alt?: string;
}
```

**Features:**

- Uses GPT-4o with JSON output format
- Validates JSON structure
- Handles both array and object responses
- Extracts style hints from style system (oceanic → "cool teal/cyan lighting")
- Fallback plan when AI unavailable
- Industry-specific prompts (marine biology → underwater scenes, not generic offices)

---

## Files Modified

### 1. `server/services/merlinDesignLLM.ts`

**Changes:**

- Added import: `import { planImagesForSite, type PlannedImage } from '../ai/imagePlannerLLM';`
- Added `plannedImages` variable declaration outside try block for metadata access
- Added Phase 5.5: AI Image Planner (before image generation)
- Maps planned images to sections by `sectionKey`
- Attaches `imagePlans` to each `SectionDefinition`
- Replaced old `generateSectionImages()` call with `generateSectionImagesV65()`
- Updated metadata to include `plannedImages` and `generatedImages`

**New Function:**

```typescript
async function generateSectionImagesV65(
  projectConfig: ProjectConfig,
  designContext: DesignContext,
  styleSystem: StyleSystem,
  layout: LayoutStructure,
  plannedImages: PlannedImage[]
): Promise<void>;
```

**Key Features:**

- Maps planned images by `sectionKey`
- Generates hero images using AI-planned prompts (always HD, cinematic)
- Generates supporting/icon/background images using planned prompts
- Populates `section.imageUrl` (primary) and `section.supportImages[]` (additional)
- Rate limiting: 1 second between additional images
- Logs image generation progress
- Stores generated images in layout for metadata

### 2. `server/generator/layoutLLM.ts`

**Changes:**

- Extended `SectionDefinition` interface:
  - Added `imagePlans?: PlannedImage[]` field
  - Added `supportImages?: Array<{ url: string; alt: string }>` field
  - Added `key?: string` field for section identification

### 3. `server/generator/codeGenerator.ts`

**Changes:**

- Updated `renderFeatures2Column()` to use `supportImages` for icons
- Icons fall back to emoji if no images available
- Icon images properly sized and styled

### 4. `server/ai/version.ts`

**Changes:**

- Updated `MERLIN_VERSION` to `'6.5-ai-image-planner'`
- Added `'v6.5-ai-image-planner'` to features array

### 5. `docs/CHANGELOG-6x.md`

**Changes:**

- Added v6.5 entry with full details:
  - Added features
  - Changed features
  - Technical details
  - Impact

### 6. `docs/merlin-6x-architecture.md`

**Changes:**

- Updated v6.4 status to "Complete"
- Added v6.5 section with "CURRENT" status
- Listed all v6.5 features and modules

---

## Technical Implementation Details

### Image Planning Flow

1. **Phase 5.5: AI Image Planner** (after style system, before image generation)
   - Calls `planImagesForSite(designContext, sectionPlan, styleSystem)`
   - GPT-4o generates image plans based on:
     - Industry (e.g., "marine biology research lab")
     - Emotional tone (e.g., "professional", "trustworthy")
     - Style system (e.g., oceanic palette → "cool teal/cyan lighting")
     - Section plan (section types, importance, notes)
   - Returns array of `PlannedImage` objects
   - Saves to `image-plan.json`

2. **Image Plan Mapping**
   - Maps planned images to sections by `sectionKey` (e.g., "hero-1", "about-1")
   - Attaches `imagePlans` array to each `SectionDefinition`
   - Logs mapping results

3. **Image Generation** (Phase 6)
   - Calls `generateSectionImagesV65()` with planned images
   - For each section:
     - Finds hero image (priority) → generates HD, cinematic
     - Finds supporting/icon/background images → generates standard/HD
     - Populates `section.imageUrl` (primary)
     - Populates `section.supportImages[]` (additional)
   - Rate limiting: 1 second between additional images
   - Logs generation progress

4. **HTML Rendering** (Phase 7)
   - Features/services sections use `supportImages` for icons
   - Hero sections use `imageUrl` for hero image
   - About sections use `imageUrl` for side images
   - Images placed correctly based on variant layout

### Style System Integration

**Style Hint Extraction:**

- Analyzes `styleSystem.colors.primary` for color themes:
  - Blue/cyan/teal → "cool blue tones" or "oceanic aesthetic"
  - Green/emerald → "natural green tones"
  - Red/crimson → "warm red tones"
  - Purple/violet → "sophisticated purple tones"
  - Gray/slate → "clean, serious, polished"
- Analyzes `styleSystem.typography.heading.font` for typography hints:
  - Serif → "classic, elegant typography"
  - Sans-serif → "modern, clean typography"

**Prompt Enhancement:**

- Style hints incorporated into image prompts
- Example: Oceanic palette → "cool teal/cyan lighting, marine atmosphere, oceanic aesthetic"
- Example: Legal palette → "clean, serious, polished, minimalist grayscale"

### Image Purpose Types

1. **Hero** (`purpose: "hero"`)
   - Always 1 per hero section
   - HD quality, cinematic style
   - Industry-specific, compelling prompts
   - Example: "Underwater marine biology research scene with coral reefs, marine life, scientific equipment, cool teal lighting"

2. **Supporting** (`purpose: "supporting"`)
   - 1-2 per about/services/features sections
   - HD quality, photorealistic/modern style
   - Contextual to section content
   - Example: "Professional marine biology team in research lab environment"

3. **Icon** (`purpose: "icon"`)
   - 1-3 per features/services sections
   - Standard quality, illustration style
   - Simple, abstract, vector-style
   - Example: "Simple icon-style illustration representing marine biology features"

4. **Background** (`purpose: "background"`)
   - 0-1 per CTA/hero sections
   - HD quality, subtle, atmospheric
   - Non-distracting
   - Example: "Subtle, atmospheric background with oceanic theme"

---

## Testing & Verification

### Test Cases

**1. Smith & Associates Law Firm** (Known Industry)

- ✅ Hero: Professional office or legal scene
- ✅ About: Office/team/meeting visuals
- ✅ Features: Simple icon-like images
- ✅ No AI style override (known industry)
- ✅ Images match legal industry tone

**2. CloudSync Pro SaaS** (Known Industry)

- ✅ Hero: Cloud dashboard UI / abstract tech visuals
- ✅ Features: UI components, isometric icons
- ✅ No AI style override (known industry)
- ✅ Images match SaaS/tech industry tone

**3. Oceanic Research Institute** (Niche Industry)

- ✅ Hero: MUST use MARINE/UNDERWATER imagery (not generic SaaS icons)
- ✅ Supporting images: Ocean/marine biology ecosystem
- ✅ AI style override activated (niche industry)
- ✅ Images match oceanic style palette
- ✅ Prompts reflect marine biology industry

### Verification Checklist

- [x] Image planning generates prompts for all sections
- [x] Hero sections always get hero images
- [x] Prompts reflect correct industry (not generic)
- [x] Visuals align with v6.2 style palette
- [x] Each section has appropriate visuals
- [x] Images properly placed in HTML (side, background, icons)
- [x] Metadata includes plannedImages and generatedImages
- [x] image-plan.json saved correctly
- [x] Fallback plan works when AI unavailable

---

## Impact & Benefits

### Before v6.5

- Generic hero images (e.g., "professional business hero image")
- Random supporting images (not industry-specific)
- No visual consistency with style system
- Marine biology sites got generic SaaS icons
- Images didn't match industry or tone

### After v6.5

- ✅ Industry-specific hero images (e.g., "underwater marine biology research scene")
- ✅ Contextual supporting images (e.g., "marine biology team in research lab")
- ✅ Visual consistency with style system (oceanic palette → marine visuals)
- ✅ Marine biology sites get appropriate marine imagery
- ✅ Images match industry, tone, and style system

### Key Improvements

1. **Visual Consistency:** All images align with v6.2 style system
2. **Industry Accuracy:** Images match actual industry (not generic)
3. **Thematic Alignment:** Images match emotional tone and visual identity
4. **Better UX:** More appropriate visuals improve user experience
5. **Professional Quality:** AI-planned prompts produce higher-quality images

---

## Known Limitations & Future Enhancements

### Current Limitations

1. **Rate Limiting:** 1 second between additional images (could be optimized)
2. **Icon Generation:** Icons are simple illustrations (could be more sophisticated)
3. **Avatar Generation:** Testimonials don't yet use avatars from imagePlans (optional feature)
4. **Image Caching:** No caching of generated images (could save API costs)

### Future Enhancements (v6.6+)

1. **Image Caching:** Cache generated images to avoid regeneration
2. **Avatar Generation:** Generate avatars for testimonials
3. **Image Optimization:** Compress/resize images for web
4. **Image Variants:** Generate multiple variants per image for A/B testing
5. **Image Quality Scoring:** Score generated images and regenerate if low quality

---

## Conclusion

Merlin v6.5 successfully transforms image generation from a basic approach to a structured, AI-driven system. Images are now intelligently planned per section based on industry, tone, layout variant, and style system, ensuring visual consistency and thematic alignment. The system is production-ready and significantly improves the quality and appropriateness of generated website visuals.

**Status:** ✅ Complete and ready for production use.

---

## Appendix: Example Image Plans

### Oceanic Research Institute (Niche Industry)

**Hero Image:**

```json
{
  "sectionKey": "hero-1",
  "purpose": "hero",
  "prompt": "Underwater marine biology research scene with coral reefs, diverse marine life, scientific research equipment, cool teal/cyan lighting, marine atmosphere, oceanic aesthetic, highly detailed, digital art",
  "styleHint": "oceanic, cool tones",
  "alt": "Underwater marine biology research scene"
}
```

**About Image:**

```json
{
  "sectionKey": "about-1",
  "purpose": "supporting",
  "prompt": "Professional marine biology research team in modern laboratory environment, working with marine specimens, cool teal/cyan lighting, marine atmosphere",
  "styleHint": "oceanic, professional",
  "alt": "Marine biology research team in laboratory"
}
```

**Features Icons:**

```json
{
  "sectionKey": "features-1",
  "purpose": "icon",
  "prompt": "Simple icon-style illustration representing marine biology research features, cool teal/cyan tones, minimalist design",
  "styleHint": "oceanic, minimal",
  "alt": "Marine biology research feature icon"
}
```

---

**Report Generated:** 2025-01-20  
**Version:** 6.5-ai-image-planner  
**Status:** ✅ Complete
